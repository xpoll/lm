<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~
  ~   ~ Copyright (c) 2014 杭州端点网络科技有限公司
  ~
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Notice">
    <resultMap id="NoticeMap" type="Notice">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="level" column="level"/>
        <result property="type" column="type"/>
        <result property="context" column="context"/>
        <result property="creatorId" column="creator_id"/>
        <result property="creatorName" column="creator_name"/>
        <result property="shopId" column="shop_id"/>
        <result property="status" column="status"/>
        <result property="picUrl" column="pic_url"/>
        <result property="summary" column="summary"/>
        <result property="startAt" column="start_at"/>
        <result property="endAt" column="end_at"/>
        <result property="extra" column="extra"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <sql id="columns">
        `level`,`title`, creator_name, `type`, creator_id, shop_id, status, pic_url, context,summary,
         start_at, end_at, extra, created_at, updated_at
    </sql>

    <sql id="values">
        #{level},#{title}, #{creatorName}, #{type}, #{creatorId}, #{shopId}, #{status}, #{picUrl}, #{context},#{summary},
         #{startAt}, #{endAt}, #{extra}, now(), now()
    </sql>

    <sql id="table">
        `parana_notice`
    </sql>

    <sql id="updateNotice">
        <set>
            <if test="level!=null">level = #{level},</if>
            <if test="title!=null">title = #{title},</if>
            <if test="creatorName!=null">creator_name = #{creatorName},</if>
            <if test="creatorId!=null">creator_id = #{creatorId},</if>
            <if test="type!=null">type = #{type},</if>
            <if test="status!=null">status = #{status},</if>
            <if test="shopId!=null">shop_id = #{shopId},</if>
            <if test="picUrl!=null">pic_url = #{picUrl},</if>
            <if test="summary!=null">summary = #{summary},</if>
            <if test="extra!=null">extra = #{extra},</if>
            <if test="context!=null">context = #{context},</if>
            <if test="startAt!=null">start_at = #{startAt},</if>
            <if test="endAt!=null">end_at = #{endAt},</if>
            updated_at=now()
        </set>
    </sql>

    <insert id="create" parameterType="Notice" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO <include refid="table"/>
        (<include refid="columns"/>) VALUES
        (<include refid="values"/>)
    </insert>

    <sql id="criteria">
        status &lt; 2
        <if test="status!=null">and status = #{status}</if>
        <if test="creatorId!=null">and creator_id=#{creatorId}</if>
        <if test="level!=null">and level=#{level}</if>
        <if test="type!=null"> and type=#{type} </if>
        <if test="shopId!=null"> and shop_id=#{shopId} </if>
        <if test="search!=null">and (title LIKE CONCAT('%','${search}','%') or context LIKE CONCAT('%','${search}','%')or summary LIKE CONCAT('%','${search}','%'))</if>
        <if test="startAt!=null"> and created_at &gt;= #{startAt} </if>
        <if test="endAt!=null"> and created_at &lt;= #{endAt} </if>
    </sql>

    <update id="updateNoticeById" parameterType="Notice">
        UPDATE <include refid="table"/>
        <set>
            <if test="title!=null">title = #{title},</if>
            <if test="creatorName!=null">creator_name = #{creatorName},</if>
            <if test="creatorId!=null">creator_id = #{creatorId},</if>
            <if test="type!=null">type = #{type},</if>
            <if test="status!=null">status = #{status},</if>
            <if test="picUrl!=null">pic_url = #{picUrl},</if>
            <if test="summary!=null">summary = #{summary},</if>
            <if test="extra!=null">extra = #{extra},</if>
            <if test="context!=null">context = #{context},</if>
            <if test="startAt!=null">start_at = #{startAt},</if>
            <if test="endAt!=null">end_at = #{endAt},</if>
            updated_at=now()
        </set>
        WHERE id = #{id}
    </update>

    <update id="updateStatus" parameterType="map">
        UPDATE <include refid="table"/>
        set status=#{status},updated_at=now()
        WHERE id = #{id}
    </update>

    <delete id="deleteNotice" parameterType="long">
        DELETE FROM <include refid="table"/>
        WHERE id = #{id}
    </delete>

    <select id="findById" parameterType="long" resultMap="NoticeMap">
        SELECT id, <include refid="columns"/>
        FROM <include refid="table"/>
        WHERE id = #{id} and status &lt; 2
    </select>

    <select id="findAll" resultMap="NoticeMap">
        SELECT id, <include refid="columns"/>
        FROM <include refid="table"/>
        WHERE status &lt; 2
    </select>

    <select id="paging" parameterType="map" resultMap="NoticeMap">
        SELECT id, <include refid="columns"/>
        FROM<include refid="table"/>
        <where>
            <include refid="criteria"/>
        </where>
        ORDER BY updated_at DESC limit #{offset}, #{limit}
    </select>

    <select id="count" parameterType="map" resultType="long">
        SELECT count(1)
        FROM
        <include refid="table"/>
        <where>
            <include refid="criteria"/>
        </where>
    </select>

</mapper>